# Redirect HTTP to HTTPS for {{ item.servername }}
server {
	listen 80;
	listen [::]:80;

	server_name {{ item.servername }};
	server_tokens off;

	rewrite ^/\.well-known/acme-challenge/(.*)$ http://secure.europython.eu/.well-known/acme-challenge/$1 redirect;

	return 301 https://$server_name$request_uri;
}

# https://{{ item.servername }} server
server {
	listen 443 ssl http2;
	listen [::]:443 ssl http2;

        server_name {{ item.servername }};
	server_tokens off;
        client_max_body_size 50M;

        ssl_certificate /home/letsencrypt/certs/secure.europython.eu/fullchain.cer;
        ssl_certificate_key /home/letsencrypt/certs/secure.europython.eu/secure.europython.eu.key;
	ssl_dhparam /home/letsencrypt/certs/dhparam.pem;
	ssl_prefer_server_ciphers On;
	ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
	ssl_ciphers ECDHE+AESGCM:ECDH:DHE:AES:3DES:!AES256:!RC4:!MD5:!aNULL:!eNULL:!PSK:!SRP:!DSS:!EXP:!LOW;

	# HSTS support; note: this needs to go into location blocks as well
	add_header Strict-Transport-Security "max-age=31536000; includeSubdomains";
	add_header P3P 'CP="ALL DSP COR PSAa PSDa OUR NOR ONL UNI COM NAV"';

        # Short links; TBD
        {% for short_link in item.short_links | default({}, true) %}
	rewrite {{ short_link.from }} {{ short_link.to }};
        {% endfor %}

        {% for location in item.locations | default({}, true) %}
	location {{ location.name }} {
		alias {{ location.alias }};

		add_header P3P 'CP="ALL DSP COR PSAa PSDa OUR NOR ONL UNI COM NAV"';
		add_header Strict-Transport-Security "max-age=31536000; includeSubdomains";
                {% if location and location.auth is defined %} 
		auth_basic "{{ location.auth.basic }}";
		auth_basic_user_file {{ location.auth.basic_user_file }};
                {% endif %}
        }
        {% endfor %}

        {% if item.disable_accounts is defined  and item.disable_accounts %} 
	# Disable logins on older sites
	location /accounts/ {
		return 404;
	}
        {% endif %}

        {% if item.redirected is defined and item.redirected %} 
	return 301 {{ item.redirected }}$request_uri;
        {% else %}
	location / {

		#return 503;

		# Linked to ep2018 container
		proxy_pass {{ item.proxy_pass }};
		proxy_set_header Host $server_name;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-Host $server_name;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto https;

		add_header P3P 'CP="ALL DSP COR PSAa PSDa OUR NOR ONL UNI COM NAV"';
		add_header Strict-Transport-Security "max-age=31536000; includeSubdomains";
	}
        {% endif %}
}
